function usage() {
    echo "Usage: $0 [options]"
    echo "Runs RTL simulation until earliest encountered limit."
    echo "Options:"
    echo "  -i NUM     Simulation is limited by number of executed"
    echo "             instructions. Default the limit is not set."
    echo "  -r NUM     Simulation time limit expressed in nanoseconds."
    echo "             Default limit is ${DEFAULT_RUN_TIME}"
    echo "  -c         Enables code coverage. The processor design must be"
    echo "             compiled with code coverage option enabled."
    echo "  -t SPEC    Time resolution limit (ModelSim)."
    echo "             SPEC is in regex of (e|1|10|100)(fs|ps|ns|us|ms|sec)"
    echo "             where e is empty string. Default is ns."
    echo "  -n         Set the testbench entity name. Default is 'testbench'"
    echo "  -p         Set the program image path generic, by default the"
    echo "             generic is not set"
    echo "  -d         Set the data image path generic, by default the"
    echo "             generic is not set"
    echo "  -s         Signal address. The default signal address used for"
    echo "             completion polling. By default the generic is not set"
    echo "  -h         This help text."
}

# Function to do clean up when this script exits.
function cleanup() {
    [ -f execution_limit ] && rm execution_limit
}
trap cleanup EXIT

runtime=${DEFAULT_RUN_TIME:?}
exec_count=
sim_res=ns
tb_entity="testbench"
prog_img_generic=""
data_img_generic=""
signal_address_generic=""
data_dump_generic=""

function is_positive() {
    local val=$1
    [ $val -eq $val ] >& /dev/null || return 1 # not a number
    [ $val -gt 0 ] >& /dev/null || return 1
    return 0
}

OPTIND=1
while getopts "r:i:ct:n:p:s:d:o:h" OPTION
do
    case $OPTION in
        r)
            runtime=$OPTARG
            is_positive $runtime \
                || { echo "Expecting positive number for -i."; exit 1; }
            runtime=${runtime}
            ;;
        i)
            exec_count=$OPTARG
            is_positive $exec_count \
                || { echo "Expecting positive number for -i."; exit 1; }
            ;;
        c)
            enable_coverage=yes
            ;;
        t)
            sim_res=$OPTARG
            ;;
        n)  tb_entity=$OPTARG
            ;;
        p)  prog_img_generic=" -gimem_image=$OPTARG "
            ;;
        d)  data_img_generic=" -gdmem_image=$OPTARG "
            ;;
        o)  data_dump_generic=" -gdmem_dump_path=$OPTARG "
            ;;
        s)  signal_address_generic=" -gcompletion_signal_address_g=$OPTARG "
            ;;
        h)
            usage
            exit 0
            ;;
        ?)
            usage
            exit 1
            ;;
    esac
done
shift "$((OPTIND-1))"

[ -f execution_limit ] && rm execution_limit
if [ -n "$exec_count" ]; then
    echo "$exec_count" > execution_limit
fi

